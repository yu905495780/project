define(["config/ifpConfig","service/ifpAPIService","service/ifpJumpService","filter/toTrustFilter.min","directive/digitalOnly.min","directive/chineseRestrict.min","directive/englishComma.min","directive/englishDigital.min","directive/englishDigitalDashSlash.min"],function(n){n.controller("ifpQueryCtrl",["$rootScope","$scope","$http","$location","$filter","$q","$timeout","$uibModal","IFPAPIService","IFPJumpService",function(n,t,i,r,u,f,e,o,s,h){function nt(n){var r=!0,i=angular.extend({},n),f;return!1&&l||(t.saleValue.end&&t.saleValue.start?(f=new Date(u("date")(t.saleValue.start,"yyyy-MM-dd")),f.setMonth(f.getMonth()+3),t.saleValue.end-t.saleValue.start<0?(c("销售日期结束日期必须大于开始日期"),r=!1):t.saleValue.end>f&&(c("销售日期跨度不可以大于3个月"),r=!1)):(c("销售日期为必须填写, 请完善销售日期"),r=!1)),r?(i.status=="-1"&&delete i.status,i.productType=="-1"&&delete i.productType,!1&&l&&(delete i.saleDateStart,delete i.saleDateEnd),angular.forEach(i,function(n,t){i[t]=((n||"")+"").trim()}),i.airline&&(i.airline=i.airline.toUpperCase()),i.depCity&&(i.depCity=i.depCity.toUpperCase()),i.arrCity&&(i.arrCity=i.arrCity.toUpperCase()),i):r}function p(){b();var n=f.defer();return i({method:"post",url:s.ifpBaseUrl+(l?"policy/searchRt":"policy/searchOw"),timeout:1e4,data:v}).success(function(t){n.resolve(t);a()}).error(function(t,i){n.reject(i);a()}),n.promise}function w(n){n.success?n.data?(t.pagination.total=n.data.total,t.pagination.page=n.data.pageNum,t.pagination.perPage=n.data.pageSize,t.pagination.pages=n.data.pages,t.pagination.show=!0,t.list=n.data.list,angular.element(".paginationInput input").val(t.pagination.page),d(t.list)):y():(y(),c(_.map(n.errMsg,function(n){return n}).join("<br>")).then(function(){h.login(n)}))}function y(){t.list=[];t.pagination.total=0;t.pagination.page=1;t.pagination.pages=0;t.pagination.show=!0;angular.element(".paginationInput input").val(t.pagination.page)}function b(){n.showLoading=!0}function a(){n.showLoading=!1}var l=t.isDouble=r.search().ctrl=="ifpQueryDouble",k={id:"",status:"-1",productType:"-1",airline:"",depCity:"",arrCity:"",fileCode:"",cabin:"",saleDateStart:"",saleDateEnd:"",agent:"",pageNum:1,pageSize:20,orderColumn:"",travelType:l?"2":"1"},v,d,g,c;t.search=angular.extend({},k);t.list=[],function(n,t){var i=new Date;n.saleValue={start:new Date(i.getFullYear(),i.getMonth(),i.getDate()),startOpen:!1,end:t,endOpen:!1};n.saleValue.end=new Date(i.getFullYear(),i.getMonth()+3,i.getDate());n.saleStartOpenClick=function(){n.saleValue.startOpen=!0};n.saleEndOpenClick=function(){n.saleValue.endOpen=!0};n.$watch("saleValue.start",function(){n.search.saleDateStart=u("date")(n.saleValue.start,"yyyy-MM-dd")||""});n.search.saleDateStart=u("date")(n.saleValue.start,"yyyy-MM-dd")||"";n.$watch("saleValue.end",function(){n.search.saleDateEnd=u("date")(n.saleValue.end,"yyyy-MM-dd")||""});n.search.saleDateEnd=u("date")(n.saleValue.end,"yyyy-MM-dd")||""}(t),function(n){n.searchClick=function(){var t=nt(n.search),i;t&&(v=angular.extend({},t),i=p().then(function(n){w(n)},function(n){n==-1?c("请求超时"):c("网络异常");y()}))};n.resetClick=function(){angular.extend(n.search,k);var t=new Date;n.saleValue.start=new Date(t.getFullYear(),t.getMonth(),t.getDate());n.saleValue.end=new Date(t.getFullYear(),t.getMonth()+3,t.getDate())};n.goClick=function(n){window.open(n)};n.download=function(){window.open(s.ifpBaseUrl+"policy/download/"+(l?"2":"1"))};n.importDialogConfig={title:"导入",show:!1,src:"./ifpImport.html?ctrl="+(l?"ifpImportDouble":"ifpImport")};n.detailClick=function(n){window.open("./ifpShow.html?ctrl="+(l?"ifpShowDouble":"ifpShow")+"&id="+n.id)}}(t),function(n){function t(){var t=[];return _.each(n.list,function(n){n.checked&&t.push(n.id)}),t}function r(n){var r={ids:n,travelType:l?"2":"1",condition:v},t;return b(),t=f.defer(),i({method:"post",url:s.ifpBaseUrl+"policy/batchDelete",data:r}).success(function(n){a();t.resolve(n)}).error(function(n,i){a();t.reject(i)}),t.promise}function u(n){var r={ids:n,travelType:l?"2":"1",condition:v},t;return b(),t=f.defer(),i({method:"post",url:s.ifpBaseUrl+"policy/batchHangUp",data:r}).success(function(n){a();t.resolve(n)}).error(function(n,i){a();t.reject(i)}),t.promise}function e(n){var r={ids:n,travelType:l?"2":"1",condition:v},t;return b(),t=f.defer(),i({method:"post",url:s.ifpBaseUrl+"policy/batchRepublish",data:r}).success(function(n){a();t.resolve(n)}).error(function(n,i){a();t.reject(i)}),t.promise}function k(n,t,r){var e={ids:n,travelType:l?"2":"1",stateBefore:t,stateAfter:r,condition:v},u;return b(),u=f.defer(),i({method:"post",url:s.ifpBaseUrl+"policy/batchUpdate",data:e}).success(function(n){a();u.resolve(n)}).error(function(n,t){a();u.reject(t)}),u.promise}function g(){var t={condition:angular.extend({},v),travelType:l?"2":"1"},n;return b(),n=f.defer(),i({method:"post",url:s.ifpBaseUrl+"policy/export",data:t}).success(function(t){a();n.resolve(t)}).error(function(t,i){a();n.reject(i)}),n.promise}n.selectAll=!1;n.checkAllClick=function(){n.selectAll=!n.selectAll;n.selectAll==!0?angular.forEach(n.list,function(n){n.checked=!0}):angular.forEach(n.list,function(n){n.checked=!1})};n.checkClick=function(){var t=!0;_.each(n.list,function(n){n.checked||(t=!1)});n.selectAll=n.list.length&&t?!0:!1};n.suspendSelectClick=function(){var n=t();if(n.length){if(!confirm("确认批量挂起吗?"))return!1;u(n).then(function(n){n&&n.success?(c(n.data||"批量挂起成功"),p().then(function(n){w(n)},function(n){n==-1?c("请求超时"):c("网络异常");y()})):c(_.map(n.errMsg,function(n){return n}).join("<br>")||"批量挂起失败").then(function(){h.login(n)})},function(n){n==-1?c("请求超时"):c("网络异常")})}else c("请选择")};n.resumeSelectClick=function(){var n=t();if(n.length){if(!confirm("确认批量投放吗?"))return!1;e(n).then(function(n){n&&n.success?(c(n.data||"批量解挂成功"),p().then(function(n){w(n)},function(n){n==-1?c("请求超时"):c("网络异常");y()})):c(_.map(n.errMsg,function(n){return n}).join("<br>")||"批量解挂失败").then(function(){h.login(n)})},function(n){n==-1?c("请求超时"):c("网络异常")})}else c("请选择")};n.deleteSelectClick=function(){var n=t();if(n.length){if(!confirm("确认批量删除吗?"))return!1;r(n).then(function(n){n&&n.success?(c(n.data||"批量删除成功"),p().then(function(n){w(n)},function(n){n==-1?c("请求超时"):c("网络异常");y()})):c(_.map(n.errMsg,function(n){return n}).join("<br>")||"批量删除失败").then(function(){h.login(n)})},function(n){n==-1?c("请求超时"):c("网络异常")})}else c("请选择")};n.exportClick=function(){if(!confirm("确认是否按照当前查询条件进行批量导出"))return!1;g().then(function(n){n.success?confirm(n.data||"正在处理中，是否跳转到批量操作记录进行查看?")&&window.open("./ifpOpRecord.html?ctrl="+(l?"ifpOpRecordDouble":"ifpOpRecord")+"&tasktype=2"):c(_.map(n.errMsg,function(n){return n}).join("<br>")||"导出失败").then(function(){h.login(n)})},function(n){n==-1?c("请求超时"):c("网络异常")})};n.editSelectClick=function(){if(!confirm("确认是否按照当前查询条件进行批量修改"))return!1;var t=[],i=d({ok:function(){if(n.stageChange.beforState=="-1"){n.stageChange.valid=!1;n.stageChange.reason="请选择修改前状态";return}if(n.stageChange.afterState=="-1"){n.stageChange.valid=!1;n.stageChange.reason="请选择修改后状态";return}n.stageChange.valid=!0;n.stageChange.reason="";confirm("确认修改吗?")&&k(t,n.stageChange.beforState,n.stageChange.afterState).then(function(n){n&&n.success?(i.close(),confirm(n.data||"正在处理中，是否跳转到批量操作记录进行查看?")&&window.open("./ifpOpRecord.html?ctrl="+(l?"ifpOpRecordDouble":"ifpOpRecord"))):c(_.map(n.errMsg,function(n){return n}).join("<br>")||"修改失败").then(function(){h.login(n)})},function(n){n==-1?c("请求超时"):c("网络异常")})}})};n.stageChange={beforState:"-1",afterState:"-1",valid:!0,reason:""};n.beforStateChange=function(){console.info(n.stageChange.beforState);n.stageChange.afterState="-1"};var d=function(t){n.stageChange.beforState="-1";n.stageChange.afterState="-1";n.stageChange.valid=!0;n.stageChange.reason="";var i=o.open({templateUrl:"ifpSelectedEdit.html",bindToController:!0,controllerAs:"$ctrl",bindToController:!0,scope:n,backdrop:"static"});return n.batchOkClick=function(){typeof t.ok=="function"&&t.ok()},n.batchCloseClick=function(){i.dismiss()},i}}(t),function(n){function t(n){b();var t=f.defer();return i.post(s.ifpBaseUrl+"policy/deleteById",{id:n}).success(function(n){a();t.resolve(n)}).error(function(n){a();t.reject(n)}),t.promise}function r(n){var t=f.defer();return i.post(s.ifpBaseUrl+"policy/hangUpById",{id:n}).success(function(n){t.resolve(n)}).error(function(n){t.reject(n)}),t.promise}function u(n){var t=f.defer();return i.post(s.ifpBaseUrl+"policy/republishById",{id:n}).success(function(n){t.resolve(n)}).error(function(n){t.reject(n)}),t.promise}function e(n){var t=f.defer();return i.post(s.ifpBaseUrl+"policy/checkExistence",{id:n}).success(function(n){t.resolve(n)}).error(function(n){t.reject(n)}),t.promise}n.deleteClick=function(n){if(confirm("确定删除吗?")){var i=t(n.id);i.then(function(n){n&&n.success?(c("删除成功"),p().then(function(n){w(n)},function(n){n==-1?c("请求超时"):c("网络异常");y()})):c(_.map(n.errMsg,function(n){return n}).join("<br>")).then(function(){h.login(n)})},function(){c("网络异常")})}};n.suspendClick=function(n){confirm("确定挂起吗?")&&r(n.id).then(function(n){n&&n.success?(c("挂起成功"),p().then(function(n){w(n)},function(n){n==-1?c("请求超时"):c("网络异常");y()})):c(_.map(n.errMsg,function(n){return n}).join("<br>")||"挂起失败").then(function(){h.login(n)})},function(){c("网络异常")})};n.resumeClick=function(n){if(confirm("确定投放吗?")){var t=u(n.id);t.then(function(n){n&&n.success?(c("投放成功"),p().then(function(n){w(n)},function(n){n==-1?c("请求超时"):c("网络异常");y()})):c(_.map(n.errMsg,function(n){return n}).join("<br>")||"投放失败").then(function(){h.login(n)})},function(){c("网络异常")})}};n.editClick=function(n){e(n.id).then(function(t){t.success?window.open("./ifpAdd.html?ctrl="+(l?"ifpEditDouble":"ifpEdit")+"&id="+n.id):c(_.map(t.errMsg,function(n){return n}).join("<br>")||"不可修改").then(function(){h.login(t)})},function(){c("网络异常")})}}(t);v=angular.extend({},t.search);d=function(n){for(var i,t,r=0,u=n.length;r<u;r++)i=n[r],t=[],(t=i.depCities.split(",")).length>20?(t=_.take(t,19),t.push("..."),i.depCitiesShow=t.join(",")):i.depCitiesShow=i.depCities,(t=i.arrCities.split(",")).length>20?(t=_.take(t,19),t.push("..."),i.arrCitiesShow=t.join(",")):i.arrCitiesShow=i.arrCities},function(n){n.pagination={perPage:20,page:1,maxSize:10,total:0,pages:0};var t=1;n.paginationChange=function(){v.pageNum=n.pagination.page;var i=angular.element(".paginationInput input");p().then(function(r){w(r);r.success?i.val(t=n.pagination.page):i.val(n.pagination.page=t=1)},function(r){r==-1?c("请求超时"):c("网络异常");y();i.val(n.pagination.page=t=1)})};n.pageBlur=function(i){var f=window.event?i.keyCode:i.which,r,u;if(f!=13)return!0;if(r=i.target,u=r.value.trim()||n.pagination.page,parseInt(u,10)){if(u==n.pagination.page)return!1;v.pageNum=u;p().then(function(i){w(i);i.success?(t=r.value=n.pagination.page,v.pageNum=t):(r.value=t=1,v.pageNum=t)},function(t){t==-1?c("请求超时"):c("网络异常");y();r.value=n.pagination.page})}}}(t);g=function(n){var i=o.open({templateUrl:"ifpDialog.html",bindToController:!0,controllerAs:"$ctrl",size:n.size,bindToController:!0,scope:t,backdrop:"static"});i.result.then(function(){typeof n.ok=="function"&&n.ok()},function(){typeof n.cancel=="function"&&n.cancel()});t.dialogOkClick=function(){i.close()};t.dialogCancelClick=function(){i.dismiss()}};c=function(n){var i=f.defer();return t.dialogContent=n,g({size:"sm",ok:function(){i.resolve()}}),i.promise}}]);angular.bootstrap(document,["ifpApp"])});
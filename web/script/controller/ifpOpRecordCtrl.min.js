define(["config/ifpConfig","service/ifpAPIService","service/ifpJumpService","filter/toTrustFilter",],function(n){n.controller("ifpOpRecordCtrl",["$rootScope","$scope","$http","$location","$filter","$q","$stateParams","$uibModal","IFPAPIService","IFPJumpService",function(n,t,i,r,u,f,e,o,s,h){function nt(n){var r=!0,i=angular.extend({},n);return t.opValue.end&&t.opValue.start&&t.opValue.end-t.opValue.start<0&&(c("结束日期必须大于开始日期"),r=!1),r?(i.taskType=="-1"&&delete i.taskType,angular.forEach(i,function(n,t){i[t]=((n||"")+"").trim()}),i):r}function p(){d();var n=f.defer();return i({method:"post",url:s.ifpBaseUrl+"policy/getTaskProgressList",timeout:1e4,data:l}).success(function(t){n.resolve(t);v()}).error(function(t,i){n.reject(i);v()}),n.promise}function w(n){n.success?n.data?(t.pagination.total=n.data.total,t.pagination.page=n.data.pageNum,t.pagination.perPage=n.data.pageSize,t.pagination.pages=n.data.pages,t.list=n.data.list,t.pagination.show=!0,angular.element(".paginationInput input").val(t.pagination.page)):a():(c(_.map(n.errMsg,function(n){return n}).join("<br>")||"查询失败").then(function(){h.login(n)}),a())}function a(){t.list=[];t.pagination.total=0;t.pagination.page=1;t.pagination.pages=0;t.pagination.show=!0;angular.element(".paginationInput input").val(t.pagination.page)}function d(){n.showLoading=!0}function v(){n.showLoading=!1}var y=r.search().tasktype,g=t.isDouble=r.search().ctrl=="ifpOpRecordDouble",tt=r.$$path=="/bgOpRecord",b={operateTimeStart:"",operateTimeEnd:"",taskType:y>0&&y<6?y:"-1",operator:"",fareType:g?2:1,pageNum:"1",pageSize:"20"},l,k,c;t.search=angular.extend({},b),function(n,t){var i=new Date;n.opValue={start:new Date(i.getFullYear(),i.getMonth(),i.getDate()),startOpen:!1,end:t,endOpen:!1};n.opValue.end=new Date(i.getFullYear(),i.getMonth()+3,i.getDate());n.opStartOpenClick=function(){n.opValue.startOpen=!0};n.opEndOpenClick=function(){n.opValue.endOpen=!0};n.$watch("opValue.start",function(){n.search.operateTimeStart=u("date")(n.opValue.start,"yyyy-MM-dd")||""});n.$watch("opValue.end",function(){n.search.operateTimeEnd=u("date")(n.opValue.end,"yyyy-MM-dd")||""});n.search.operateTimeStart=u("date")(n.opValue.start,"yyyy-MM-dd")||"";n.search.operateTimeEnd=u("date")(n.opValue.end,"yyyy-MM-dd")||""}(t),function(n){n.searchClick=function(){var t=nt(n.search),i;t&&(l=angular.extend({},t),i=p().then(function(n){w(n)},function(n){n==-1?c("请求超时"):c("网络异常");a()}))};n.resetClick=function(){angular.extend(n.search,b);var t=new Date;n.opValue.start=new Date(t.getFullYear(),t.getMonth(),t.getDate());n.opValue.end=new Date(t.getFullYear(),t.getMonth()+3,t.getDate())}}(t);l={};t.downloadClick=function(n,t){window.open(s.ifpBaseUrl+"policy/downloadFile?id="+t+"&url="+n)},function(n){var t,i;n.pagination={perPage:20,page:1,maxSize:10,total:0,pages:0};t=1;n.paginationChange=function(){l.pageNum=n.pagination.page;var i=angular.element(".paginationInput input");p().then(function(r){w(r);r.success?i.val(t=n.pagination.page):i.val(n.pagination.page=t=1)},function(r){r==-1?c("请求超时"):c("网络异常");a();i.val(n.pagination.page=t=1)})};i=angular.element(".paginationInput input");n.pageBlur=function(i){var f=window.event?i.keyCode:i.which,r,u;if(f!=13)return!0;if(r=i.target,u=r.value.trim()||n.pagination.page,parseInt(u,10)){if(u==n.pagination.page)return!1;l.pageNum=u;p().then(function(i){w(i);i.success?(t=r.value=n.pagination.page,l.pageNum=t):(a(),r.value=t=1,l.pageNum=t)},function(t){t==-1?c("请求超时"):c("网络异常");a();r.value=n.pagination.page})}}}(t);k=function(n){var i=o.open({templateUrl:"ifpDialog.html",bindToController:!0,controllerAs:"$ctrl",size:n.size,bindToController:!0,scope:t,backdrop:"static"});i.result.then(function(){typeof n.ok=="function"&&n.ok()},function(){typeof n.cancel=="function"&&n.cancel()});t.dialogOkClick=function(){i.close()};t.dialogCancelClick=function(){i.dismiss()}};c=function(n){var i=f.defer();return t.dialogContent=n,k({size:"sm",ok:function(){i.resolve()}}),i.promise};t.searchClick()}]);angular.bootstrap(document,["ifpApp"])});